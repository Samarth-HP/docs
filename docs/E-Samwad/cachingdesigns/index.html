<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/docs/blog/rss.xml" title="Sammarth Docs Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs/blog/atom.xml" title="Sammarth Docs Blog Atom Feed"><title data-react-helmet="true">E-Samwad Caching Designs | Sammarth Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://samarth-hp.github.io/docs/docs/docs/E-Samwad/cachingdesigns"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="E-Samwad Caching Designs | Sammarth Docs"><meta data-react-helmet="true" name="description" content="1. Caching"><meta data-react-helmet="true" property="og:description" content="1. Caching"><link data-react-helmet="true" rel="shortcut icon" href="/docs/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://samarth-hp.github.io/docs/docs/docs/E-Samwad/cachingdesigns"><link data-react-helmet="true" rel="alternate" href="https://samarth-hp.github.io/docs/docs/docs/E-Samwad/cachingdesigns" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://samarth-hp.github.io/docs/docs/docs/E-Samwad/cachingdesigns" hreflang="x-default"><link rel="stylesheet" href="/docs/assets/css/styles.95fcde6a.css">
<link rel="preload" href="/docs/assets/js/runtime~main.b67fa4a7.js" as="script">
<link rel="preload" href="/docs/assets/js/main.a4b639bd.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/"><img src="/docs/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/docs/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Samagra Docs</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/docs/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Samarth-HP/docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/docs/intro">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">E-Samwad Docs</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/E-Samwad/ESamwadOverview">E-Samwad Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/E-Samwad/SamwadFuncSpecs">Samwad - Functional Specifications</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/E-Samwad/assessmentmodule">E-Samwad Assessment Module</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/E-Samwad/businesslogic">E-Samwad Business Logics</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/E-Samwad/deploysamwad">Deploy Samwad</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/docs/E-Samwad/cachingdesigns">E-Samwad Caching Designs</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/docs/mermaid">Docusaurus Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorial - Basics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorial - Extras</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>E-Samwad Caching Designs</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="1-caching"></a>1. Caching<a class="hash-link" href="#1-caching" title="Direct link to heading">#</a></h2><p><img alt="caching_flow" src="/docs/assets/images/caching-layer-dd04dcf2bf14f1eb903977e0310c405e.png"></p><p>Caching Design proved to be one of the most important aspect in esamwad&#x27;s applcation layer to maintain application performance, high availibility and high tolerance. It helped in our scaling decisions too.
When pondering around the use cases of esamwad around the schools in Himachal Pradesh and amount of load it will be creating, different designs for caching was considered.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="2-analysis"></a>2. Analysis<a class="hash-link" href="#2-analysis" title="Direct link to heading">#</a></h2><ol><li>We knew that recently requested data is likely to be requested again by many different users, so by taking advantage of the locality of reference principle we leveraged this to reduce our API response time and improve applications performance.</li></ol><p><img src="/docs/assets/images/caching-635732290e7882c27826f35b12cfaae7.png"></p><ol start="2"><li>Then, it was the decision on which layer to apply caching on. Ex- client, web server, application or on database.
While there were pros and cons for every decision that could have been taken. The important part was to decide what will be best suited for our use case, i.e. to serve APIs which return repititive data and are stable on high load.</li></ol><ul><li>Though we do have a MongoDB Realm SDK used on our Android App used for caching and offline support, but it has dependencies on phone memory and third party permissions. So client side caching was not the optimal solution.</li></ul><p>To tackle this issue we decided to leverage django signals for updating our cache tables on event signals without adding extra dependencies on invalidating and hydrating the cache from time to time. We are also using redis for caching static queries and maintaining keys for cache invalidation and hydration purpose.</p><p><img alt="django_signals" src="/docs/assets/images/signals-django-8d528ee5536a325df3a3c2b1b628f467.png"></p><p>Django includes a ‚Äúsignal dispatcher‚Äù which helps decoupled applications get notified when actions occur elsewhere in the framework. In a nutshell, signals allow certain senders to notify a set of receivers that some action has taken place. They‚Äôre especially useful when many pieces of code may be interested in the same events.
Django provides a set of built-in signals that let user code get notified by Django itself of certain actions.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="3-design-for-current-caching-implementation-in-esamwad"></a>3. Design for current caching implementation in eSamwad:<a class="hash-link" href="#3-design-for-current-caching-implementation-in-esamwad" title="Direct link to heading">#</a></h2><p>We decided on this design for caching in our current application version to store our cache globally in our main database and have added a feature flag <em>IS_CACHE_ENABLED</em> to control the caching in the application in a more modular way without hindering with overall application code structure.</p><p><img alt="caching-esamwad" src="/docs/assets/images/caching-esamwad-959d207161b19a2aa9f9c36c916c05ca.PNG"></p><p>We started our implementation around the signals and developed logics to revalidate our cache on each signal triggers by sending tasks through celery to a queue manager which would asyncronously update the cache tables. Though it seemed to work properly but these also had their own challenges.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="problems-faced-and-learnings"></a>Problems Faced and Learnings<a class="hash-link" href="#problems-faced-and-learnings" title="Direct link to heading">#</a></h3><ol><li>The workers on queue manager (RabbitMQ in our case) runs the task asynchronous so when a task is sent to the queue manager there is no callback for the  responses of the task, i.e if it failed or completed successfully. So in cases if there is too much lag on the queue manager it would take uncertain amount of time to determine when the task will get completed or even if it got completed or not. </li><li>Other issue was the performance of the application, as signals themselves are synchronous in nature so it affected the API performance causing a little overtime on APIs response time when a signal event was triggered. It caused lag in the admin console too, on updating the entries in table through admin console it didn&#x27;t ensure if the queue manager will update the cache in realtime and user may still seem to see older data for a certain time. The major challenge here that we faced was having a good performance on the broker side so that tasks sent could be executed in realtime and should be fast. One of the ways to improve the performance that we figured out was internal query optimisations in API logic layer which in turn made the API calls very slow and workers performance seem to be affected with this causing the little lags in the tasks getting executed.</li><li>To ensure no duplicate tasks are sent to the broker or to ensure if other parallel task on the broker does not interfere with the previous queued tasks we used redis for maintaining keys to ensure no duplicate task gets added to perform the same task.</li><li>Even after maintaining the number of tasks being sent to the broker for cache invalidation and hydration, we saw issues on queries which took slighlty longer time to execute (i.e. around 300-600ms). These queries started creating lags on the queue manager when the load increased on the application and load on the database increased too much to execute so many queued queries. This again caused the failure of as application became very slow as the number of users increased and we started facing server timeout issues. To this problem we found out that the query which was taking so much time was returning mostly static data and it can be cached as its not updated too frequntly in the application, i.e. the query bringed meta data information on a particular assessments which rarely gets changed once the assessment is created, so we decided to cache this query too using redis keys and decided to flush these keys if any changes are made to these meta data. Currently we decided to flush the keys manually if any requirements come from the field to change the assessment meta data and decided to rethink and test on scenarios over time to add automatic cache validation and hydration on these event changes.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="4-improvements"></a>4. Improvements<a class="hash-link" href="#4-improvements" title="Direct link to heading">#</a></h2><p>Facing challenges on improving the API performance and broker issues, we decided to first start from optimising our internal queries and bussiness logics.</p><p>We did manage to optimise our API and internal database calls by caching static queries and assessment data to achieve the maximum performance in least time and were able to bring down the average time on the main assessment meta data API. The average time taken to execute the big static query was cut down from 300-400ms to 30-40ms which was 100x faster.</p><blockquote><p>Benchmarks results before optimisation:</p></blockquote><p><img src="/docs/assets/images/benchmarks_before_optimisation-e826169cd2c8b977cdca2a1bab3ee326.PNG"></p><blockquote><p>Benchmarks results before optimisation:</p></blockquote><p><img src="/docs/assets/images/benchmarks_after_optimisation-e1c63c3817002e66953ee62d563b9b07.PNG"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="5-ongoing"></a>5. Ongoing<a class="hash-link" href="#5-ongoing" title="Direct link to heading">#</a></h2><p>So we achived the best performance for our APIs from this, now the task remained to increase the performance and availibility of the broker and properly leverage the django signals so that no tasks are skipped and the caches are updated automatically on signal calls.</p><p>We are considering to have periodic celery beat tasks which after specified amount of time goes and revalidate the caches even if no triggers occur to ensure that caches are always updated and we get better benchmarks.</p><p>We are also creating a list of use cases for each signals from the django-dispatcher and how it should be interpreted to update the cache. We planned to enable these signals over time when we see the requirements to update the caches on these event triggers frequently. Its not done straightaway because the use case for such events are very less right now and it will only cause more load on queue manager, workers and database to perform so many asynchronous tasks and queries.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Samarth-HP/docs/docs/E-Samwad/E-Samwad-Caching-Designs.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/docs/E-Samwad/deploysamwad"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Deploy Samwad</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/docs/mermaid"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Docusaurus Introduction ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-caching" class="table-of-contents__link">1. Caching</a></li><li><a href="#2-analysis" class="table-of-contents__link">2. Analysis</a></li><li><a href="#3-design-for-current-caching-implementation-in-esamwad" class="table-of-contents__link">3. Design for current caching implementation in eSamwad:</a><ul><li><a href="#problems-faced-and-learnings" class="table-of-contents__link">Problems Faced and Learnings</a></li></ul></li><li><a href="#4-improvements" class="table-of-contents__link">4. Improvements</a></li><li><a href="#5-ongoing" class="table-of-contents__link">5. Ongoing</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/mermaid">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docs/assets/js/runtime~main.b67fa4a7.js"></script>
<script src="/docs/assets/js/main.a4b639bd.js"></script>
</body>
</html>